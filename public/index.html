<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wheel Strategy Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .pl-positive {
            color: green;
            font-weight: bold;
        }

        .pl-negative {
            color: red;
            font-weight: bold;
        }

        canvas {
            max-height: 400px;
        }
    </style>
</head>

<body class="bg-light p-4">
    <div class="container">
        <h1 class="text-center mb-4">Wheel Strategy Tracker</h1>

        <!-- Add Trade Form -->
        <div class="card p-3 mb-4">
            <h4>Add Trade</h4>
            <form id="tradeForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Type (CC or CSP)</label>
                        <select id="type" class="form-select" required>
                            <option value="CSP">Cash Secured Put</option>
                            <option value="CC">Covered Call</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ticker</label>
                        <input id="ticker" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Strike Price ($)</label>
                        <input type="number" id="strike" class="form-control" step="0.01" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Lots (1 lot = 100 shares)</label>
                        <input type="number" id="lots" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Premium ($)</label>
                        <input type="number" id="premium" class="form-control" step="0.01" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date</label>
                        <input type="date" id="date" class="form-control" required />
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" type="submit">Add</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Summary Section -->
        <div class="card p-3 mb-4">
            <h4>Summary</h4>
            <p><strong>Total Premium Earned:</strong> $<span id="totalPremium">0</span></p>
            <p><strong>Total Investment Required:</strong> $<span id="totalInvestment">0</span></p>
            <p><strong>Annualized Return:</strong> <span id="annualizedReturn">0%</span></p>
            <p><strong>Overall Profit (CC + CSP):</strong> $<span id="overallProfit">0</span></p>
        </div>

        <!-- Refresh Button -->
        <div class="mb-3 text-end">
            <button id="refreshBtn" class="btn btn-success">Refresh Prices</button>
        </div>

        <!-- Trade History Table -->
        <div class="card p-3 mb-4">
            <h4>Trade History</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Ticker</th>
                        <th>Premium</th>
                        <th>Strike</th>
                        <th>Lots</th>
                        <th>Investment</th>
                        <th>Live Price</th>
                        <th>ITM?</th>
                        <th>P/L</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tradeTable"></tbody>
            </table>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="card p-3 mb-4">
                    <h5>Premium Over Time</h5>
                    <canvas id="premiumChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 mb-4">
                    <h5>Investment Over Time</h5>
                    <canvas id="investmentChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-4">
            <h5>Profit by Stock (All Trades)</h5>
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <script>
        let trades = JSON.parse(localStorage.getItem("wheelTrades") || "[]");

        const form = document.getElementById("tradeForm");
        const table = document.getElementById("tradeTable");
        const refreshBtn = document.getElementById("refreshBtn");

        let premiumChart, investmentChart, pieChart;

        function saveTrades() {
            localStorage.setItem("wheelTrades", JSON.stringify(trades));
        }

        function renderTable() {
            table.innerHTML = trades.map((t, idx) => {
                return `<tr data-idx="${idx}">
                    <td>${t.type}</td>
                    <td>${t.ticker}</td>
                    <td>$${t.premium.toFixed(2)}</td>
                    <td>$${t.strike.toFixed(2)}</td>
                    <td>${t.lots}</td>
                    <td>$${t.collateral.toFixed(2)}</td>
                    <td class="live">-</td>
                    <td class="itm">-</td>
                    <td class="pl">-</td>
                    <td>${t.date}</td>
                    <td><button class="btn btn-sm btn-danger removeBtn">Remove</button></td>
                </tr>`;
            }).join("");

            document.querySelectorAll(".removeBtn").forEach(btn => {
                btn.onclick = () => {
                    const idx = btn.closest("tr").dataset.idx;
                    trades.splice(idx, 1);
                    saveTrades();
                    renderTable();
                    updateSummary();
                    renderCharts();
                    updatePieChart();
                };
            });
        }

        function updateSummary() {
            const totalPremium = trades.reduce((s, t) => s + t.premium, 0);
            const totalInvestment = trades.reduce((s, t) => s + t.collateral, 0);
            const overallProfit = trades.reduce((s, t) => s + (t.latestPL || 0), 0);
            const annualized = totalInvestment ? ((totalPremium / totalInvestment) * 100).toFixed(2) : 0;

            document.getElementById("totalPremium").textContent = totalPremium.toFixed(2);
            document.getElementById("totalInvestment").textContent = totalInvestment.toFixed(2);
            document.getElementById("annualizedReturn").textContent = annualized + "%";
            document.getElementById("overallProfit").textContent = overallProfit.toFixed(2);
        }

        function renderCharts() {
            const labels = trades.map(t => t.date || "-");
            const premiums = trades.map(t => t.premium);
            const investments = trades.map(t => t.collateral);

            if (premiumChart) premiumChart.destroy();
            if (investmentChart) investmentChart.destroy();

            premiumChart = new Chart(document.getElementById("premiumChart"), {
                type: "line",
                data: { labels, datasets: [{ label: "Premium", data: premiums, borderColor: 'blue', backgroundColor: 'rgba(0,0,255,0.1)' }] },
                options: { responsive: true }
            });

            investmentChart = new Chart(document.getElementById("investmentChart"), {
                type: "line",
                data: { labels, datasets: [{ label: "Investment", data: investments, borderColor: 'orange', backgroundColor: 'rgba(255,165,0,0.1)' }] },
                options: { responsive: true }
            });
        }

        function updatePieChart() {
            const profitByTicker = {};
            trades.forEach(t => {
                if (!profitByTicker[t.ticker]) profitByTicker[t.ticker] = 0;
                profitByTicker[t.ticker] += t.latestPL || 0;
            });

            const labels = Object.keys(profitByTicker);
            const data = Object.values(profitByTicker);

            if (pieChart) pieChart.destroy();

            const ctx = document.getElementById("pieChart").getContext("2d");
            pieChart = new Chart(ctx, {
                type: "pie",
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: labels.map((_, i) => `hsl(${i * 60},70%,50%)`)
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        form.addEventListener("submit", e => {
            e.preventDefault();
            const strikeVal = Number(document.getElementById("strike").value);
            const lotsVal = Number(document.getElementById("lots").value);
            const collateralCalc = strikeVal * 100 * lotsVal;

            const trade = {
                type: document.getElementById("type").value,
                ticker: document.getElementById("ticker").value.toUpperCase(),
                strike: strikeVal,
                lots: lotsVal,
                premium: Number(document.getElementById("premium").value),
                collateral: collateralCalc,
                date: document.getElementById("date").value
            };

            trades.push(trade);
            saveTrades();
            renderTable();
            updateSummary();
            renderCharts();
            updatePieChart();
            form.reset();
        });

        async function fetchYahooPrice(ticker) {
            try {
                const res = await fetch(`/api/price/${ticker}`);
                const data = await res.json();
                return data.quoteResponse?.result?.[0]?.regularMarketPrice || null;
            } catch (err) {
                console.error("Proxy fetch error:", err);
                return null;
            }
        }

        async function updateLivePrices() {
            const rows = Array.from(document.querySelectorAll("#tradeTable tr"));
            for (let i = 0; i < trades.length; i++) {
                const t = trades[i];
                const row = rows[i];
                if (!row) continue;

                const live = await fetchYahooPrice(t.ticker);
                let itm = "-", pl = 0;

                if (live !== null) {
                    if (t.type === "CSP") {
                        itm = live < t.strike ? "YES" : "NO";
                        const intrinsic = Math.max(0, t.strike - live) * 100 * t.lots;
                        pl = t.premium * 100 * t.lots - intrinsic;
                    } else {
                        itm = live > t.strike ? "YES" : "NO";
                        const intrinsic = Math.max(0, live - t.strike) * 100 * t.lots;
                        pl = t.premium * 100 * t.lots - intrinsic;
                    }
                    t.latestPL = pl;
                    row.querySelector(".live").textContent = "$" + live.toFixed(2);
                    row.querySelector(".itm").textContent = itm;
                    const plCell = row.querySelector(".pl");
                    plCell.textContent = pl.toFixed(2);
                    plCell.className = "pl " + (pl >= 0 ? "pl-positive" : "pl-negative");
                }
            }
            updateSummary();
            updatePieChart();
        }

        // Initial load
        renderTable();
        updateSummary();
        renderCharts();
        updatePieChart();
        updateLivePrices();

        refreshBtn.addEventListener("click", updateLivePrices);
    </script>
</body>

</html>
