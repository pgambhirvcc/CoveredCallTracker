<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wheel Strategy Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .pl-positive {
      color: green;
      font-weight: bold;
    }

    .pl-negative {
      color: red;
      font-weight: bold;
    }
  </style>
</head>

<body class="bg-light p-4">
  <div class="container">
    <h1 class="text-center mb-4">Wheel Strategy Tracker</h1>

    <!-- Add Trade Form -->
    <div class="card p-3 mb-4">
      <h4>Add Trade</h4>
      <form id="tradeForm">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Type (CC or CSP)</label>
            <select id="type" class="form-select" required>
              <option value="CSP">Cash Secured Put</option>
              <option value="CC">Covered Call</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ticker</label>
            <input id="ticker" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Strike Price ($)</label>
            <input type="number" id="strike" class="form-control" step="0.01" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Lots (1 lot = 100 shares)</label>
            <input type="number" id="lots" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Premium ($)</label>
            <input type="number" id="premium" class="form-control" step="0.01" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Date</label>
            <input type="date" id="date" class="form-control" required />
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" type="submit">Add</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Summary Section -->
    <div class="card p-3 mb-4">
      <h4>Summary</h4>
      <p><strong>Total Premium Earned:</strong> $<span id="totalPremium">0</span></p>
      <p><strong>Total Investment Required:</strong> $<span id="totalInvestment">0</span></p>
      <p><strong>Annualized Return:</strong> <span id="annualizedReturn">0%</span></p>
      <p><strong>Overall Profit (CC + CSP):</strong> $<span id="overallProfit">0</span></p>
    </div>

    <!-- Refresh Button -->
    <div class="mb-3 text-end">
      <button id="refreshBtn" class="btn btn-success">Refresh Prices</button>
    </div>

    <!-- Trade History Table -->
    <div class="card p-3 mb-4">
      <h4>Trade History</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Type</th>
            <th>Ticker</th>
            <th>Premium</th>
            <th>Strike</th>
            <th>Lots</th>
            <th>Investment</th>
            <th>Live Price</th>
            <th>ITM?</th>
            <th>P/L</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tradeTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    let trades = [];
    const table = document.getElementById("tradeTable");
    const refreshBtn = document.getElementById("refreshBtn");
    const form = document.getElementById("tradeForm");

    async function loadTrades() {
      try {
        const res = await fetch("/api/trades");
        trades = await res.json();
        renderTable();
        await updateLivePrices();
      } catch (err) { console.error(err); }
    }

    function renderTable() {
      table.innerHTML = trades.map((t, idx) => `
        <tr data-idx="${idx}">
          <td>${t.type}</td>
          <td>${t.ticker}</td>
          <td>$${t.premium.toFixed(2)}</td>
          <td>$${t.strike.toFixed(2)}</td>
          <td>${t.lots}</td>
          <td>$${t.collateral.toFixed(2)}</td>
          <td class="live">-</td>
          <td class="itm">-</td>
          <td class="pl">-</td>
          <td>${t.date}</td>
          <td><button class="btn btn-sm btn-danger removeBtn">Remove</button></td>
        </tr>`).join("");

      document.querySelectorAll(".removeBtn").forEach(btn => {
        btn.onclick = async () => {
          const idx = btn.closest("tr").dataset.idx;
          const id = trades[idx].id;
          await fetch(`/api/trade/${id}`, { method: "DELETE" });
          trades.splice(idx, 1);
          renderTable();
          updateSummary();
        }
      });

      updateSummary();
    }

    function updateSummary() {
      const totalPremium = trades.reduce((s, t) => s + t.premium, 0);
      const totalInvestment = trades.reduce((s, t) => s + t.collateral, 0);
      const overallProfit = trades.reduce((s, t) => s + (t.latestPL || 0), 0);
      const annualized = totalInvestment ? ((totalPremium / totalInvestment) * 100).toFixed(2) : 0;
      document.getElementById("totalPremium").textContent = totalPremium.toFixed(2);
      document.getElementById("totalInvestment").textContent = totalInvestment.toFixed(2);
      document.getElementById("annualizedReturn").textContent = annualized + "%";
      document.getElementById("overallProfit").textContent = overallProfit.toFixed(2);
    }

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const trade = {
        type: document.getElementById("type").value,
        ticker: document.getElementById("ticker").value.toUpperCase(),
        strike: Number(document.getElementById("strike").value),
        lots: Number(document.getElementById("lots").value),
        premium: Number(document.getElementById("premium").value),
        collateral: Number(document.getElementById("strike").value) * 100 * Number(document.getElementById("lots").value),
        date: document.getElementById("date").value
      };
      const res = await fetch("/api/trade", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(trade)
      });
      trades.push(await res.json());
      renderTable();
      await updateLivePrices();
      form.reset();
    });

    async function fetchYahooPrice(ticker) {
      try {
        const res = await fetch(`/api/price/${ticker}`);
        const data = await res.json();
        return data.regularMarketPrice || data.quoteResponse?.result?.[0]?.regularMarketPrice || null;
      } catch { return null; }
    }

    async function updateLivePrices() {
      const rows = Array.from(document.querySelectorAll("#tradeTable tr"));
      const updates = [];
      for (let i = 0; i < trades.length; i++) {
        const t = trades[i];
        const row = rows[i];
        if (!row) continue;
        const live = await fetchYahooPrice(t.ticker);
        if (live !== null) {
          let itm = "-", pl = 0;
          if (t.type === "CSP") {
            itm = live < t.strike ? "YES" : "NO";
            pl = t.premium * 100 * t.lots - Math.max(0, t.strike - live) * 100 * t.lots;
          } else {
            itm = live > t.strike ? "YES" : "NO";
            pl = t.premium * 100 * t.lots - Math.max(0, live - t.strike) * 100 * t.lots;
          }
          t.latestPL = pl;
          row.querySelector(".live").textContent = "$" + live.toFixed(2);
          row.querySelector(".itm").textContent = itm;
          const plCell = row.querySelector(".pl");
          plCell.textContent = pl.toFixed(2);
          plCell.className = "pl " + (pl >= 0 ? "pl-positive" : "pl-negative");

          updates.push(fetch(`/api/trade/pl/${t.id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ latestPL: pl })
          }));
        }
      }
      updateSummary();
      await Promise.all(updates);
    }

    refreshBtn.addEventListener("click", updateLivePrices);
    loadTrades();
  </script>
</body>

</html>
