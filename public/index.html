<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wheel Strategy Tracker</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background:#f5f6fa; font-family:'Segoe UI',sans-serif; color:#333; }
h1 { font-weight:600; }
.summary-box { background:#fff; padding:15px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
.section-title { margin-top:30px; font-weight:600; color:#555; }
table { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.03); }
thead { background:#e9ecef; font-weight:600; }
th, td { vertical-align:middle !important; }
.pl-positive { color:#28a745; font-weight:600; }
.pl-negative { color:#dc3545; font-weight:600; }
.stock-positive { color:#0d6efd; font-weight:600; }
.stock-negative { color:#fd7e14; font-weight:600; }
.btn-primary { background-color:#007bff; border:none; }
.btn-primary:hover { background-color:#0069d9; }
input, select { border-radius:6px; }
</style>
</head>
<body class="p-4">
<div class="container">

<h1 class="text-center mb-4">Wheel Strategy Tracker</h1>

<!-- Add Trade Form -->
<div class="card p-3 mb-4 shadow-sm">
  <h4>Add Trade</h4>
  <form id="tradeForm" class="row g-3">
    <div class="col-md-2">
      <label class="form-label">Type</label>
      <select id="type" class="form-select" required>
        <option value="CSP">Cash Secured Put</option>
        <option value="CC">Covered Call</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Ticker</label>
      <input id="ticker" class="form-control" required />
    </div>
    <div class="col-md-2">
      <label class="form-label">Strike ($)</label>
      <input type="number" id="strike" class="form-control" required />
    </div>
    <div class="col-md-2">
      <label class="form-label">Lots</label>
      <input type="number" id="lots" class="form-control" required />
    </div>
    <div class="col-md-2">
      <label class="form-label">Premium ($)</label>
      <input type="number" id="premium" class="form-control" step="0.01" required />
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit">Add Trade</button>
    </div>
  </form>
</div>

<!-- Current Holdings Form -->
<div class="card p-3 mb-4 shadow-sm">
  <h4>Current Holdings (Manual)</h4>
  <form id="holdingForm" class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Ticker</label>
      <input id="holdingTicker" class="form-control" required />
    </div>
    <div class="col-md-3">
      <label class="form-label">Entry Price ($)</label>
      <input type="number" id="holdingEntry" class="form-control" step="0.01" required />
    </div>
    <div class="col-md-3">
      <label class="form-label">Quantity</label>
      <input type="number" id="holdingLots" class="form-control" required />
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit">Add Holding</button>
    </div>
  </form>
</div>

<!-- Summary Boxes -->
<div class="row text-center mb-4 g-3">
  <div class="col-md-3 summary-box"><h6>Total Premium</h6><span id="totalPremium">$0</span></div>
  <div class="col-md-3 summary-box"><h6>Total Stock</h6><span id="totalStock">$0</span></div>
  <div class="col-md-3 summary-box"><h6>Overall Profit</h6><span id="overallProfit">$0</span></div>
  <div class="col-md-3 summary-box"><h6>Accumulated Weekly</h6><span id="accumWeekly">0%</span></div>
</div>

<!-- Weekly Chart -->
<h4 class="section-title">Weekly Premium (CSP vs CC)</h4>
<div class="summary-box mb-4">
  <canvas id="weeklyProfitChart" height="120"></canvas>
</div>

<!-- Current Positions -->
<h4 class="section-title">Current Positions (Not Expired)</h4>
<table class="table table-striped shadow-sm mb-4">
<thead>
<tr>
  <th>Type</th><th>Ticker</th><th>Strike</th><th>Lots</th><th>Premium</th>
  <th>Collateral</th><th>Live Price</th><th>ITM?</th><th>Unrealized P/L</th>
</tr>
</thead>
<tbody id="currentPositions"></tbody>
</table>

<!-- Current Holdings Table -->
<h4 class="section-title">Manual Holdings</h4>
<table class="table table-striped shadow-sm mb-4">
<thead>
<tr>
  <th>Ticker</th><th>Entry Price</th><th>Quantity</th><th>Current Price</th><th>Unrealized P/L</th><th>Actions</th>
</tr>
</thead>
<tbody id="manualPortfolio"></tbody>
</table>

<!-- Trade History -->
<h4 class="section-title">Trade History (Expired)</h4>
<table class="table table-striped shadow-sm mb-4">
<thead>
<tr>
  <th>Type</th><th>Ticker</th><th>Strike</th><th>Lots</th>
  <th>Premium Profit</th><th>Stock Profit</th><th>Total Profit</th><th>Expiry</th>
</tr>
</thead>
<tbody id="tradeHistory"></tbody>
</table>

<script>
let trades = [], manualHoldings = [], weeklyChart;

// DOM Elements
const totalPremiumEl = document.getElementById("totalPremium");
const totalStockEl = document.getElementById("totalStock");
const overallProfitEl = document.getElementById("overallProfit");
const accumWeeklyEl = document.getElementById("accumWeekly");
const currentPositions = document.getElementById("currentPositions");
const manualPortfolio = document.getElementById("manualPortfolio");
const tradeHistory = document.getElementById("tradeHistory");
const weeklyProfitCanvas = document.getElementById("weeklyProfitChart");

// Helper to fetch live price
async function fetchPrice(ticker){
  try{
    const res = await fetch(`/api/price/${ticker}`);
    const data = await res.json();
    return data.price ?? 0;
  }catch{return 0;}
}

// ISO week string
function getISOWeek(date){
  const d = new Date(date);
  d.setDate(d.getDate() + 3 - (d.getDay() + 6)%7);
  const week1 = new Date(d.getFullYear(),0,4);
  return `${d.getFullYear()}-W${String(1 + Math.round(((d-week1)/86400000 - 3 + (week1.getDay()+6)%7)/7)).padStart(2,"0")}`;
}

// Load trades & holdings from backend
async function loadTrades(){
  const res = await fetch("/api/trades");
  trades = await res.json();
  await loadHoldings();
  await updateAll();
}

// Load manual holdings
async function loadHoldings(){
  const res = await fetch("/api/holdings");
  manualHoldings = await res.json();
}

// Add trade
document.getElementById("tradeForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const trade = {
    type: document.getElementById("type").value,
    ticker: document.getElementById("ticker").value.toUpperCase(),
    strike: Number(document.getElementById("strike").value),
    lots: Number(document.getElementById("lots").value),
    premium: Number(document.getElementById("premium").value),
    date: new Date().toISOString().split('T')[0],
    collateral: Number(document.getElementById("strike").value)*100*Number(document.getElementById("lots").value),
  };
  const res = await fetch("/api/trade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(trade)});
  trades.push(await res.json());
  await updateAll();
  e.target.reset();
});

// Add manual holding
document.getElementById("holdingForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const ticker = document.getElementById("holdingTicker").value.toUpperCase();
  const entry = Number(document.getElementById("holdingEntry").value);
  const lots = Number(document.getElementById("holdingLots").value);
  const res = await fetch("/api/holding",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ticker,entry,lots})});
  manualHoldings.push(await res.json());
  await updateManualPortfolio();
  e.target.reset();
});

// Delete holding
async function deleteHolding(id){
  await fetch(`/api/holding/${id}`,{method:"DELETE"});
  manualHoldings = manualHoldings.filter(h=>h._id!==id);
  updateManualPortfolio();
}

// Update all
async function updateAll(){
  await updateTrades();
  await updateManualPortfolio();
  buildWeeklyChart();
}

// Update trades
async function updateTrades(){
  const today = new Date();
  let totalPremium=0, totalStock=0;
  const currentPos=[], history=[];

  for(let t of trades){
    const price = await fetchPrice(t.ticker);
    const expiry = new Date(t.date);
    const premiumVal = t.premium*100*t.lots;

    if(today<expiry){
      const unrealized = premiumVal - (t.type==="CSP"?Math.max(0,t.strike-price)*100*t.lots : Math.max(0,price-t.strike)*100*t.lots);
      currentPos.push({...t, price, unrealized});
    }else{
      let stockProfit=0;
      if(t.type==="CC" && price>t.strike) stockProfit = (t.strike*100*t.lots)-t.collateral;
      totalPremium += premiumVal;
      totalStock += stockProfit;
      history.push({...t, premiumProfit: premiumVal, stockProfit});
    }
  }

  totalPremiumEl.textContent = "$"+totalPremium.toFixed(2);
  totalStockEl.textContent = "$"+totalStock.toFixed(2);
  overallProfitEl.textContent = "$"+(totalPremium+totalStock).toFixed(2);

  // Accumulated Weekly
  const accumWeekly = calculateAccumulatedWeekly(trades);
  accumWeeklyEl.textContent = accumWeekly + "%";

  // Current Positions
  currentPositions.innerHTML = currentPos.map(t=>`
    <tr>
      <td>${t.type}</td><td>${t.ticker}</td><td>$${t.strike}</td><td>${t.lots}</td>
      <td>$${t.premium}</td><td>$${t.collateral}</td><td>$${t.price.toFixed(2)}</td>
      <td>${t.type==="CSP"? (t.price<t.strike?"YES":"NO") : (t.price>t.strike?"YES":"NO")}</td>
      <td class="${t.unrealized>=0?'pl-positive':'pl-negative'}">$${t.unrealized.toFixed(2)}</td>
    </tr>`).join("");

  // Trade History
  tradeHistory.innerHTML = history.map(t=>`
    <tr>
      <td>${t.type}</td><td>${t.ticker}</td><td>$${t.strike}</td><td>${t.lots}</td>
      <td class="${t.premiumProfit>=0?'pl-positive':'pl-negative'}">$${t.premiumProfit.toFixed(2)}</td>
      <td class="${t.stockProfit>=0?'stock-positive':'stock-negative'}">$${t.stockProfit.toFixed(2)}</td>
      <td class="${(t.premiumProfit+t.stockProfit)>=0?'pl-positive':'pl-negative'}">$${(t.premiumProfit+t.stockProfit).toFixed(2)}</td>
      <td>${t.date}</td>
    </tr>`).join("");
}

// Update manual holdings
async function updateManualPortfolio(){
  const rows = await Promise.all(manualHoldings.map(async h=>{
    const price = await fetchPrice(h.ticker);
    const pl = (price-h.entry)*h.lots;
    return {...h, current: price, pl};
  }));
  manualPortfolio.innerHTML = rows.map(h=>`
    <tr>
      <td>${h.ticker}</td><td>$${h.entry.toFixed(2)}</td><td>${h.lots}</td>
      <td>$${h.current.toFixed(2)}</td>
      <td class="${h.pl>=0?'stock-positive':'stock-negative'}">$${h.pl.toFixed(2)}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteHolding('${h._id}')">Delete</button></td>
    </tr>`).join("");
}

// Calculate accumulated weekly %
function calculateAccumulatedWeekly(trades){
  const weeklyReturns={};
  trades.forEach(t=>{
    const week = getISOWeek(t.createdAt || t._id); // fallback if createdAt missing
    const coll = t.collateral || (t.strike*100*t.lots);
    const profit = t.premium*100*t.lots;
    weeklyReturns[week] = (weeklyReturns[week]||0) + (profit/coll);
  });
  return (Object.values(weeklyReturns).reduce((a,b)=>a+b,0)*100).toFixed(2);
}

// Build weekly chart
function buildWeeklyChart(){
  const weekly={};
  trades.forEach(t=>{
    const week = getISOWeek(t.createdAt);
    weekly[week] ??= {CSP:0, CC:0};
    weekly[week][t.type] += t.premium*100*t.lots;
  });

  const labels = Object.keys(weekly);
  const csp = labels.map(w=>weekly[w].CSP);
  const cc = labels.map(w=>weekly[w].CC);

  if(weeklyChart) weeklyChart.destroy();
  weeklyChart = new Chart(weeklyProfitCanvas,{
    type:"bar",
    data:{
      labels,
      datasets:[
        {label:"CSP", data:csp, backgroundColor:"#0d6efd"},
        {label:"CC", data:cc, backgroundColor:"#28a745"}
      ]
    },
    options:{
      plugins:{
        tooltip:{
          callbacks:{
            label: ctx => `${ctx.dataset.label}: $${ctx.raw.toFixed(2)}`
          }
        }
      }
    }
  });
}

loadTrades();
</script>
</body>
</html>
